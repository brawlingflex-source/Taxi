<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>üöñ –¢–∞–∫—Å–æ–º–µ—Ç—Ä ‚Äî –ú–∏—Ö–∞–∏–ª –∏ –ù–∏–∫–æ–ª–∞–π</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #1a1e2b;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
        
        #app {
            max-width: 500px;
            width: 100%;
            background: #0b0e14;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            padding: 24px;
            color: white;
        }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .auth-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-title {
            font-size: 32px;
            font-weight: 800;
            color: #ffd700;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .auth-input {
            width: 100%;
            padding: 18px;
            background: #1e2430;
            border: 2px solid #2f3542;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            outline: none;
        }
        
        .auth-input:focus {
            border-color: #ffd700;
        }
        
        .auth-btn {
            width: 100%;
            padding: 18px;
            background: #ffd700;
            color: #0b0e14;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .auth-btn:active {
            transform: scale(0.97);
            background: #ffed4a;
        }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–∞–∫—Å–æ–º–µ—Ç—Ä–∞ - –ú–∏—Ö–∞–∏–ª */
        .taximeter-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-name {
            font-size: 28px;
            font-weight: 800;
            color: #ffd700;
        }
        
        .logout-btn {
            background: #2f3542;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* –†–µ–π—Ç–∏–Ω–≥ –∑–≤—ë–∑–¥–∞–º–∏ */
        .rating-container {
            background: linear-gradient(145deg, #151a24, #0f131c);
            padding: 20px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .rating-stars {
            display: flex;
            gap: 8px;
        }
        
        .star {
            font-size: 32px;
            color: #3a4050;
        }
        
        .star.filled {
            color: #ffd700;
        }
        
        .rating-value {
            font-size: 20px;
            color: #a0a8b8;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stats-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, #1e2430, #151a24);
            padding: 24px;
            border-radius: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #2f3542;
        }
        
        .stat-label {
            font-size: 18px;
            color: #a0a8b8;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #ffd700;
        }
        
        .stat-unit {
            font-size: 16px;
            color: #a0a8b8;
            margin-left: 8px;
        }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ù–∏–∫–æ–ª–∞—è */
        .manager-screen {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .manager-title {
            font-size: 28px;
            font-weight: 800;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .driver-status {
            background: #1e2430;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .driver-name {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 12px;
        }
        
        .driver-stats {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-section {
            background: linear-gradient(145deg, #1e2430, #151a24);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid #2f3542;
        }
        
        .control-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 20px;
        }
        
        .control-input {
            width: 100%;
            padding: 16px;
            background: #0b0e14;
            border: 2px solid #2f3542;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .control-btn {
            width: 100%;
            padding: 16px;
            background: #ffd700;
            color: #0b0e14;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 12px;
        }
        
        .control-btn:active {
            transform: scale(0.97);
            background: #ffed4a;
        }
        
        .control-btn.secondary {
            background: #2f3542;
            color: white;
        }
        
        .control-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .control-btn.warning {
            background: #ffc107;
            color: #0b0e14;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .button-group .control-btn {
            margin-bottom: 0;
        }
        
        .hidden {
            display: none;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #ffd700;
            padding: 16px 24px;
            border-radius: 30px;
            font-size: 16px;
            z-index: 1000;
            border: 1px solid #ffd700;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { bottom: 0; opacity: 0; }
            to { bottom: 30px; opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="auth-screen" class="auth-screen">
            <div class="auth-title">üöñ –¢–ê–ö–°–û–ú–ï–¢–†</div>
            <input type="text" id="username-input" class="auth-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è (–ú–∏—Ö–∞–∏–ª / –ù–∏–∫–æ–ª–∞–π)" autocomplete="off">
            <button id="login-btn" class="auth-btn">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ú–∏—Ö–∞–∏–ª–∞ (–í–æ–¥–∏—Ç–µ–ª—å) -->
        <div id="mikhail-screen" class="taximeter-screen hidden">
            <div class="header">
                <span class="user-name">üöñ –ú–∏—Ö–∞–∏–ª</span>
                <button id="logout-btn-mikhail" class="logout-btn">–í—ã–π—Ç–∏</button>
            </div>
            
            <!-- –†–µ–π—Ç–∏–Ω–≥ –∑–≤—ë–∑–¥–∞–º–∏ -->
            <div class="rating-container">
                <div class="rating-stars" id="star-rating"></div>
                <span class="rating-value" id="rating-text">0.0 ‚òÖ</span>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">üìä –ü—Ä–æ–µ—Ö–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</span>
                    <div>
                        <span class="stat-value" id="km-today">0.00</span>
                        <span class="stat-unit">–∫–º</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-label">üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                    <div>
                        <span class="stat-value" id="earned-today">0.00</span>
                        <span class="stat-unit">‚ÇΩ</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-label">‚õΩ –ë–µ–Ω–∑–∏–Ω</span>
                    <div>
                        <span class="stat-value" id="fuel-left">0.00</span>
                        <span class="stat-unit">–ª</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ù–∏–∫–æ–ª–∞—è (–ú–µ–Ω–µ–¥–∂–µ—Ä) -->
        <div id="nikolay-screen" class="manager-screen hidden">
            <div class="header">
                <span class="user-name">üìã –ù–∏–∫–æ–ª–∞–π</span>
                <button id="logout-btn-nikolay" class="logout-btn">–í—ã–π—Ç–∏</button>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å –ú–∏—Ö–∞–∏–ª–∞ -->
            <div class="driver-status">
                <div class="driver-name">üöñ –ú–∏—Ö–∞–∏–ª</div>
                <div class="driver-stats">
                    <span>‚≠ê <span id="nikolay-rating">0.0</span></span>
                    <span>üìä <span id="nikolay-km">0.00</span> –∫–º</span>
                    <span>üí∞ <span id="nikolay-money">0.00</span> ‚ÇΩ</span>
                    <span>‚õΩ <span id="nikolay-fuel">0.00</span> –ª</span>
                </div>
            </div>
            
            <div class="control-panel">
                <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤ -->
                <div class="control-section">
                    <div class="control-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä—ã</div>
                    <input type="number" id="add-km-input" class="control-input" placeholder="–ö–∏–ª–æ–º–µ—Ç—Ä—ã" step="0.01" min="0">
                    <button id="add-km-btn" class="control-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–º</button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤ -->
                    <button id="clear-km-btn" class="control-btn danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä—ã –¥–æ 0</button>
                </div>
                
                <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–µ–Ω–∑–∏–Ω–∞ -->
                <div class="control-section">
                    <div class="control-title">‚õΩ –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω–∑–∏–Ω</div>
                    <input type="number" id="add-fuel-input" class="control-input" placeholder="–õ–∏—Ç—Ä—ã" step="0.01" min="0">
                    <button id="add-fuel-btn" class="control-btn secondary">–î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω–∑–∏–Ω</button>
                </div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–∞–±–æ—Ç–∫–æ–º -->
                <div class="control-section">
                    <div class="control-title">üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–∞–±–æ—Ç–∫–æ–º</div>
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ -->
                    <button id="clear-earned-btn" class="control-btn danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –¥–æ 0</button>
                </div>
                
                <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                <div class="control-section">
                    <div class="control-title">‚≠ê –û—Ü–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                        <button id="rate-1" class="control-btn" style="flex: 1; background: #3a4050;">1‚òÖ</button>
                        <button id="rate-2" class="control-btn" style="flex: 1; background: #3a4050;">2‚òÖ</button>
                        <button id="rate-3" class="control-btn" style="flex: 1; background: #3a4050;">3‚òÖ</button>
                        <button id="rate-4" class="control-btn" style="flex: 1; background: #3a4050;">4‚òÖ</button>
                        <button id="rate-5" class="control-btn" style="flex: 1; background: #3a4050;">5‚òÖ</button>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                    <button id="clear-rating-btn" class="control-btn danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –¥–æ 0</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== FIREBASE –ö–û–ù–§–ò–ì ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
            authDomain: "messeger-0wo2h4.firebaseapp.com",
            databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
            projectId: "messeger-0wo2h4",
            storageBucket: "messeger-0wo2h4.firebasestorage.app",
            messagingSenderId: "1057251395030",
            appId: "1:1057251395030:web:86f8f718ed938055e29077"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // ========== –ö–û–ù–°–¢–ê–ù–¢–´ ==========
        const TARIFF = 120;
        const FUEL_CONSUMPTION = 0.5;
        const MIKHAIL_ID = 'mikhail_driver';

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentUserName = '';
        let mikhailListener = null;

        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const authScreen = document.getElementById('auth-screen');
        const mikhailScreen = document.getElementById('mikhail-screen');
        const nikolayScreen = document.getElementById('nikolay-screen');
        const usernameInput = document.getElementById('username-input');
        const loginBtn = document.getElementById('login-btn');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –ú–∏—Ö–∞–∏–ª–∞
        const kmTodayEl = document.getElementById('km-today');
        const earnedTodayEl = document.getElementById('earned-today');
        const fuelLeftEl = document.getElementById('fuel-left');
        const ratingTextEl = document.getElementById('rating-text');
        const starRatingEl = document.getElementById('star-rating');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –ù–∏–∫–æ–ª–∞—è
        const nikolayRatingEl = document.getElementById('nikolay-rating');
        const nikolayKmEl = document.getElementById('nikolay-km');
        const nikolayMoneyEl = document.getElementById('nikolay-money');
        const nikolayFuelEl = document.getElementById('nikolay-fuel');
        
        // ========== –§–£–ù–ö–¶–ò–ò ==========
        
        function showToast(text) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async function initDatabase() {
            const snapshot = await db.ref(`drivers/${MIKHAIL_ID}`).once('value');
            if (!snapshot.exists()) {
                await db.ref(`drivers/${MIKHAIL_ID}`).set({
                    name: '–ú–∏—Ö–∞–∏–ª',
                    kmToday: 0,
                    earnedToday: 0,
                    fuelLeft: 50,
                    ratings: [],
                    averageRating: 0
                });
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ú–∏—Ö–∞–∏–ª–∞
        function updateMikhailUI(data) {
            if (!data) return;
            
            kmTodayEl.textContent = Number(data.kmToday || 0).toFixed(2);
            earnedTodayEl.textContent = Number(data.earnedToday || 0).toFixed(2);
            fuelLeftEl.textContent = Number(data.fuelLeft || 0).toFixed(2);
            
            const rating = Number(data.averageRating || 0);
            ratingTextEl.textContent = `${rating.toFixed(1)} ‚òÖ`;
            
            generateStars(rating);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—ë–∑–¥
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<span class="star filled">‚òÖ</span>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<span class="star filled">¬Ω</span>';
                } else {
                    starsHtml += '<span class="star">‚òÜ</span>';
                }
            }
            starRatingEl.innerHTML = starsHtml;
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –ú–∏—Ö–∞–∏–ª–∞
        function subscribeToMikhail() {
            if (mikhailListener) {
                db.ref(`drivers/${MIKHAIL_ID}`).off('value', mikhailListener);
            }
            
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            mikhailListener = mikhailRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (currentUserName === '–ú–∏—Ö–∞–∏–ª') {
                        updateMikhailUI(data);
                    }
                    
                    if (currentUserName === '–ù–∏–∫–æ–ª–∞–π') {
                        nikolayKmEl.textContent = Number(data.kmToday || 0).toFixed(2);
                        nikolayMoneyEl.textContent = Number(data.earnedToday || 0).toFixed(2);
                        nikolayFuelEl.textContent = Number(data.fuelLeft || 0).toFixed(2);
                        nikolayRatingEl.textContent = Number(data.averageRating || 0).toFixed(1);
                    }
                }
            });
        }

        // ========== –î–ï–ô–°–¢–í–ò–Ø –ù–ò–ö–û–õ–ê–Ø ==========
        
        // –î–æ–±–∞–≤–∏—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä—ã
        async function addKilometers(km) {
            if (km <= 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }
            
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            const snapshot = await mikhailRef.once('value');
            const data = snapshot.val();
            
            if (!data) return;
            
            const newKm = Number(data.kmToday || 0) + km;
            const newEarned = Number(data.earnedToday || 0) + (km * TARIFF);
            const newFuel = Number(data.fuelLeft || 0) - (km * FUEL_CONSUMPTION);
            
            if (newFuel < 0) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–Ω–∑–∏–Ω–∞! –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –±–µ–Ω–∑–∏–Ω.');
                return;
            }
            
            await mikhailRef.update({
                kmToday: Number(newKm.toFixed(2)),
                earnedToday: Number(newEarned.toFixed(2)),
                fuelLeft: Number(newFuel.toFixed(2))
            });
            
            showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${km.toFixed(2)} –∫–º, –∑–∞—Ä–∞–±–æ—Ç–æ–∫ +${(km * TARIFF).toFixed(2)} ‚ÇΩ`);
        }

        // –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω–∑–∏–Ω
        async function addFuel(liters) {
            if (liters <= 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }
            
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            const snapshot = await mikhailRef.once('value');
            const data = snapshot.val();
            
            if (!data) return;
            
            const newFuel = Number(data.fuelLeft || 0) + liters;
            
            await mikhailRef.update({
                fuelLeft: Number(newFuel.toFixed(2))
            });
            
            showToast(`‚õΩ –î–æ–±–∞–≤–ª–µ–Ω–æ ${liters.toFixed(2)} –ª –±–µ–Ω–∑–∏–Ω–∞`);
        }

        // –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
        async function addRating(rating) {
            if (rating < 1 || rating > 5) return;
            
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            const snapshot = await mikhailRef.once('value');
            const data = snapshot.val();
            
            if (!data) return;
            
            const ratings = data.ratings || [];
            ratings.push(rating);
            
            const sum = ratings.reduce((a, b) => a + b, 0);
            const average = sum / ratings.length;
            
            await mikhailRef.update({
                ratings: ratings,
                averageRating: Number(average.toFixed(1))
            });
            
            showToast(`‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞: ${rating} ‚òÖ`);
        }

        // ========== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –û–ß–ò–°–¢–ö–ò ==========
        
        // –û—á–∏—Å—Ç–∏—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä—ã
        async function clearKilometers() {
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            const snapshot = await mikhailRef.once('value');
            const data = snapshot.val();
            
            if (!data) return;
            
            await mikhailRef.update({
                kmToday: 0
            });
            
            showToast('üßπ –ö–∏–ª–æ–º–µ—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã –¥–æ 0');
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫
        async function clearEarned() {
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            const snapshot = await mikhailRef.once('value');
            const data = snapshot.val();
            
            if (!data) return;
            
            await mikhailRef.update({
                earnedToday: 0
            });
            
            showToast('üí∞ –ó–∞—Ä–∞–±–æ—Ç–æ–∫ –æ—á–∏—â–µ–Ω –¥–æ 0');
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥
        async function clearRating() {
            const mikhailRef = db.ref(`drivers/${MIKHAIL_ID}`);
            
            await mikhailRef.update({
                ratings: [],
                averageRating: 0
            });
            
            showToast('‚≠ê –†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω');
        }

        // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        
        async function checkSavedSession() {
            const savedUser = localStorage.getItem('taximeter_user');
            if (savedUser) {
                await initDatabase();
                if (savedUser === '–ú–∏—Ö–∞–∏–ª') {
                    currentUserName = '–ú–∏—Ö–∞–∏–ª';
                    authScreen.classList.add('hidden');
                    mikhailScreen.classList.remove('hidden');
                    nikolayScreen.classList.add('hidden');
                    subscribeToMikhail();
                    showToast('üöñ –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, –ú–∏—Ö–∞–∏–ª!');
                } else if (savedUser === '–ù–∏–∫–æ–ª–∞–π') {
                    currentUserName = '–ù–∏–∫–æ–ª–∞–π';
                    authScreen.classList.add('hidden');
                    mikhailScreen.classList.add('hidden');
                    nikolayScreen.classList.remove('hidden');
                    subscribeToMikhail();
                    showToast('üìã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, –ù–∏–∫–æ–ª–∞–π!');
                }
            }
        }

        async function login(username) {
            if (!username) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            if (username.toLowerCase() === '–º–∏—Ö–∞–∏–ª') {
                currentUserName = '–ú–∏—Ö–∞–∏–ª';
                localStorage.setItem('taximeter_user', '–ú–∏—Ö–∞–∏–ª');
                authScreen.classList.add('hidden');
                mikhailScreen.classList.remove('hidden');
                nikolayScreen.classList.add('hidden');
                showToast('üöñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ú–∏—Ö–∞–∏–ª!');
            } 
            else if (username.toLowerCase() === '–Ω–∏–∫–æ–ª–∞–π') {
                currentUserName = '–ù–∏–∫–æ–ª–∞–π';
                localStorage.setItem('taximeter_user', '–ù–∏–∫–æ–ª–∞–π');
                authScreen.classList.add('hidden');
                mikhailScreen.classList.add('hidden');
                nikolayScreen.classList.remove('hidden');
                showToast('üìã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ù–∏–∫–æ–ª–∞–π!');
            }
            else {
                showToast('–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –ú–∏—Ö–∞–∏–ª—É –∏–ª–∏ –ù–∏–∫–æ–ª–∞—é');
                return;
            }
            
            await initDatabase();
            subscribeToMikhail();
        }

        function logout() {
            localStorage.removeItem('taximeter_user');
            currentUserName = '';
            authScreen.classList.remove('hidden');
            mikhailScreen.classList.add('hidden');
            nikolayScreen.classList.add('hidden');
            
            if (mikhailListener) {
                db.ref(`drivers/${MIKHAIL_ID}`).off('value', mikhailListener);
                mikhailListener = null;
            }
            
            usernameInput.value = '';
            showToast('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
        
        loginBtn.addEventListener('click', () => {
            login(usernameInput.value.trim());
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login(usernameInput.value.trim());
            }
        });

        document.getElementById('logout-btn-mikhail').addEventListener('click', logout);
        document.getElementById('logout-btn-nikolay').addEventListener('click', logout);

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–º
        document.getElementById('add-km-btn').addEventListener('click', () => {
            const km = parseFloat(document.getElementById('add-km-input').value);
            if (!isNaN(km)) {
                addKilometers(km);
                document.getElementById('add-km-input').value = '';
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–µ–Ω–∑–∏–Ω–∞
        document.getElementById('add-fuel-btn').addEventListener('click', () => {
            const liters = parseFloat(document.getElementById('add-fuel-input').value);
            if (!isNaN(liters)) {
                addFuel(liters);
                document.getElementById('add-fuel-input').value = '';
            }
        });

        // –û–¶–ï–ù–ö–ò
        document.getElementById('rate-1').addEventListener('click', () => addRating(1));
        document.getElementById('rate-2').addEventListener('click', () => addRating(2));
        document.getElementById('rate-3').addEventListener('click', () => addRating(3));
        document.getElementById('rate-4').addEventListener('click', () => addRating(4));
        document.getElementById('rate-5').addEventListener('click', () => addRating(5));

        // ========== –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–ß–ò–°–¢–ö–ò ==========
        
        // –û—á–∏—Å—Ç–∏—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä—ã
        document.getElementById('clear-km-btn').addEventListener('click', clearKilometers);
        
        // –û—á–∏—Å—Ç–∏—Ç—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫
        document.getElementById('clear-earned-btn').addEventListener('click', clearEarned);
        
        // –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥
        document.getElementById('clear-rating-btn').addEventListener('click', clearRating);

        // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ Firebase
        auth.signInAnonymously().catch(console.error);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
        window.addEventListener('load', () => {
            checkSavedSession();
        });
    </script>
</body>
</html>
